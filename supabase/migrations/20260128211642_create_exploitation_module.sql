/*
  # Create Exploitation Module

  1. New Tables
    - exploitation_systems: Operating systems for dam management
    - exploitation_zones: Geographic zones for dam grouping
    - exploitation_daily_data: Daily operational data for each dam
    - exploitation_flow_categories: Flow categorization (supply, hydroelectric, ecological, etc.)

  2. Security
    - Enable RLS on all tables
    - Authenticated users can view all data
    - Only authorized users can insert/update operational data

  3. Important Notes
    - Supports real-time monitoring of water levels and flows
    - Tracks inflows, outflows, and storage volumes
    - Categorizes water usage by purpose
    - Enables automatic flood risk detection
    - Complete audit trail for all operations
*/

CREATE TABLE IF NOT EXISTS exploitation_systems (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code text UNIQUE NOT NULL,
  name text NOT NULL,
  description text,
  director_id uuid REFERENCES user_profiles(id) ON DELETE SET NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS exploitation_zones (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code text UNIQUE NOT NULL,
  name text NOT NULL,
  description text,
  system_id uuid REFERENCES exploitation_systems(id) ON DELETE SET NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'dams' AND column_name = 'exploitation_zone_id'
  ) THEN
    ALTER TABLE dams 
    ADD COLUMN exploitation_zone_id uuid REFERENCES exploitation_zones(id) ON DELETE SET NULL;
  END IF;
END $$;

DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'dams' AND column_name = 'exploitation_system_id'
  ) THEN
    ALTER TABLE dams 
    ADD COLUMN exploitation_system_id uuid REFERENCES exploitation_systems(id) ON DELETE SET NULL;
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS exploitation_daily_data (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  dam_id uuid REFERENCES dams(id) ON DELETE CASCADE NOT NULL,
  date date NOT NULL,
  
  water_level decimal NOT NULL,
  stored_volume decimal NOT NULL,
  surface_area decimal DEFAULT 0,
  useful_volume decimal DEFAULT 0,
  
  inflow_total decimal DEFAULT 0,
  outflow_total decimal DEFAULT 0,
  
  outflow_supply decimal DEFAULT 0,
  outflow_hydroelectric decimal DEFAULT 0,
  outflow_ecological decimal DEFAULT 0,
  outflow_irrigation decimal DEFAULT 0,
  outflow_other decimal DEFAULT 0,
  
  evaporation decimal DEFAULT 0,
  rainfall decimal DEFAULT 0,
  
  air_temperature decimal,
  water_temperature decimal,
  
  flood_risk_level text DEFAULT 'normal' CHECK (flood_risk_level IN ('normal', 'watch', 'warning', 'alert', 'emergency')),
  flood_risk_notes text,
  
  observations text,
  registered_by uuid REFERENCES user_profiles(id) ON DELETE SET NULL NOT NULL,
  verified_by uuid REFERENCES user_profiles(id) ON DELETE SET NULL,
  verified_at timestamptz,
  
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  
  UNIQUE(dam_id, date)
);

CREATE INDEX IF NOT EXISTS idx_exploitation_daily_data_dam_id ON exploitation_daily_data(dam_id);
CREATE INDEX IF NOT EXISTS idx_exploitation_daily_data_date ON exploitation_daily_data(date DESC);
CREATE INDEX IF NOT EXISTS idx_exploitation_daily_data_flood_risk ON exploitation_daily_data(flood_risk_level);
CREATE INDEX IF NOT EXISTS idx_dams_exploitation_zone ON dams(exploitation_zone_id);
CREATE INDEX IF NOT EXISTS idx_dams_exploitation_system ON dams(exploitation_system_id);

ALTER TABLE exploitation_systems ENABLE ROW LEVEL SECURITY;
ALTER TABLE exploitation_zones ENABLE ROW LEVEL SECURITY;
ALTER TABLE exploitation_daily_data ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can view exploitation systems"
  ON exploitation_systems
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Admins can manage exploitation systems"
  ON exploitation_systems
  FOR ALL
  TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Authenticated users can view exploitation zones"
  ON exploitation_zones
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Admins can manage exploitation zones"
  ON exploitation_zones
  FOR ALL
  TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Authenticated users can view daily data"
  ON exploitation_daily_data
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Authenticated users can insert daily data"
  ON exploitation_daily_data
  FOR INSERT
  TO authenticated
  WITH CHECK (registered_by = auth.uid());

CREATE POLICY "Users can update own daily data"
  ON exploitation_daily_data
  FOR UPDATE
  TO authenticated
  USING (registered_by = auth.uid())
  WITH CHECK (registered_by = auth.uid());

CREATE POLICY "Admins can manage all daily data"
  ON exploitation_daily_data
  FOR ALL
  TO authenticated
  USING (true)
  WITH CHECK (true);

COMMENT ON TABLE exploitation_systems IS 'Operating systems for dam management';
COMMENT ON TABLE exploitation_zones IS 'Geographic zones for dam grouping';
COMMENT ON TABLE exploitation_daily_data IS 'Daily operational data for water resource management';
